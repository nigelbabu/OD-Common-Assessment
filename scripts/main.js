this.Templates=this.Templates||{},this.Templates.filter={v:3,t:[{t:7,e:"div",a:{"class":"filter"},f:["\n  ",{t:7,e:"div",a:{"class":"btn-group"},f:["\n    ",{t:7,e:"button",v:{tap:"filter.toggle"},a:{"class":"label label-default dropdown-toggle dropdown",type:"button"},f:[{t:7,e:"span",a:{"class":"text"},f:[{t:7,e:"span",f:["+"]}]}]},"\n    ",{t:7,e:"div",a:{"class":["dropdown-menu form-horizontal",{t:4,f:[" open"],r:"filter.open"}],role:"menu"},f:["\n      ",{t:7,e:"ul",f:["\n",{t:4,f:["        ",{t:7,e:"li",a:{"class":"checkbox"},f:["\n          ",{t:7,e:"label",f:["\n          ",{t:7,e:"input",a:{type:"checkbox",name:[{t:2,r:"indicators.visible"}],value:[{t:2,r:"."}],"class":[{t:2,r:"."}]}},"\n            ",{t:7,e:"span",a:{"class":"pretty"},f:["\n            ",{t:2,x:{r:["getIndicator","."],s:'_0(_1,"title")'}},"\n            "]},"\n          "]},"\n        "]},"\n"],r:"indicators.scoring"},"      "]},"\n    "]},"\n  "]},"\n"]}]},this.Templates.group={v:3,t:["\n",{t:7,e:"form",a:{"class":"form-inline",role:"menu"},f:["\n  ",{t:7,e:"label",f:["Group by:"]},"\n  ",{t:7,e:"select",a:{"class":"form-control",value:[{t:2,r:"sorting.grouping"}]},f:["\n      ",{t:7,e:"option",a:{value:"",selected:"selected"},f:["none"]},"\n",{t:4,f:["      ",{t:7,e:"option",a:{value:[{t:2,r:"."}]},f:[{t:2,x:{r:["getIndicator","."],s:'_0(_1,"title")'}}]},"\n"],n:52,i:"item",r:"indicators.grouping"},"  "]},"\n"]},"\n"]},this.Templates.list={v:3,t:[{t:7,e:"div",a:{"class":["loading fade",{t:4,f:[" in"],n:51,r:"model"}]}},"\n",{t:4,f:[{t:7,e:"div",a:{id:"grouping"},f:[{t:7,e:"grouping"}]},"\n",{t:7,e:"table",a:{"class":"countries"},f:["\n  ",{t:7,e:"thead",f:["\n    ",{t:7,e:"tr",f:["\n",{t:4,f:["      ",{t:7,e:"th",a:{"class":"grouping theader"},f:[{t:7,e:"div",a:{"class":"wrapper"},f:["Grouping"]}]},"\n"],r:"sorting.grouping"},"      ",{t:7,e:"th",v:{tap:{n:"sorting.sort",a:"title"}},a:{"class":["sortable theader ",{t:2,x:{r:["sorting.column"],s:'_0==="title"?"sorted":""'}}," ",{t:2,x:{r:["sorting.direction","sorting.column"],s:'_0===-1&&_1==="title"?"dropup":""'}}]},f:[{t:7,e:"div",a:{"class":"wrapper"},f:["Country",{t:7,e:"span",a:{"class":"caret"}}]}]},"\n      ",{t:7,e:"th",f:["\n",{t:4,f:["        ",{t:7,e:"div",a:{"class":"indicator-pil label label-default theader truncate",style:["background-color: ",{t:2,x:{r:["getIndicator","."],s:'_0(_1,"colour")'}},";"]},f:["\n            ",{t:7,e:"button",v:{tap:"indicator.remove"},a:{type:"button","class":"close","aria-label":"Close"},f:[{t:7,e:"span",a:{"aria-hidden":"true"},f:["Ã—"]},"\n            "]},"\n           ",{t:2,x:{r:["getIndicator","."],s:'_0(_1,"title")'}},"\n        "]},"\n"],i:"item",r:"indicators.visible"},"        ",{t:7,e:"div",a:{id:"filter"},f:[{t:7,e:"filtering"}]},"\n      "]},"\n      ",{t:7,e:"th",v:{tap:{n:"sorting.sort",a:"score"}},a:{"class":["score sortable theader\n        ",{t:2,x:{r:["sorting.column"],s:'_0==="score"?"sorted":""'}},"\n        ",{t:2,x:{r:["sorting.direction","sorting.column"],s:'_0===-1&&_1==="score"?"dropup":""'}}]},f:["\n        ",{t:7,e:"div",a:{"class":"wrapper"},f:["Score",{t:7,e:"span",a:{"class":"caret"}}]}]},"\n    "]},"\n  "]},"\n  ",{t:7,e:"tbody",f:["\n",{t:4,f:["    ",{t:4,f:["\n\n    ",{t:7,e:"tr",a:{"class":["data-",{t:2,r:"id"}],"data-country":[{t:2,r:"title"}]},f:["\n",{t:4,f:["        ",{t:4,f:["\n          ",{t:7,e:"td",a:{"class":"grouping-category",rowspan:[{t:2,r:"places.length"}]},f:[{t:7,e:"span",f:[{t:2,rx:{r:"valuesMap",m:[{t:30,n:"sorting.grouping"},"normalised"]}}]}]},"\n"],r:"first"}],r:"sorting.grouping"},"      ",{t:7,e:"td",a:{"class":"country"},f:[{t:7,e:"a",a:{href:["#/country/",{t:2,r:"id"}]},f:[{t:2,r:"title"}]}]},"\n      ",{t:7,e:"td",a:{"class":"results"},f:["\n        ",{t:7,e:"div",a:{"class":"result-wrapper"},f:["\n",{t:4,f:["              ",{t:7,e:"a",o:{n:"tooltip",d:['<div class="tooltip-arrow"></div>\n              <div class="tooltip-inner"><p class="ind-score">',{t:2,rx:{r:"valuesMap",m:[{t:30,n:"."},"normalised"]}},'</p><p class="title">',{t:2,x:{r:["getIndicator","."],s:'_0(_1,"title")'}},'</p><p class="description">',{t:2,x:{r:["getIndicator","."],s:'_0(_1,"description")'}},"</p></div>"]},v:{tap:"info"},a:{"class":"indicator",href:"#",title:"",style:[{t:4,f:["width: ",{t:2,x:{r:[".","valuesMap","indicators.visible.length"],s:"_1[_0].normalised/_2-1"}},"%;"],rx:{r:"valuesMap",m:[{t:30,n:"."},"normalised"]}}," background-color: ",{t:2,x:{r:["getIndicator","."],s:'_0(_1,"colour")'}}]}},"\n"],n:52,r:"indicators.visible"},"        "]},"\n      "]},"\n      ",{t:7,e:"td",a:{"class":"score"},f:[{t:2,r:"score"}]},"\n\n    "]},"\n"],r:"places"}],n:52,r:"groups"},"  "]},"\n"]},"\n"],r:"groups"}]},Ractive.prototype.remove=function(t,e){var r=this.get(t),i=r.indexOf(e);return-1!==i?this.splice(t,i,1):Promise.defer()};var tooltipDecorator=function(t,e){var r,i,o;i={mouseover:function(){r=document.createElement(tooltipDecorator.element),r.className=tooltipDecorator.className,r.innerHTML=e,r.style.left=t.offsetLeft-tooltipDecorator.offsetWidth/2+t.offsetWidth/2+"px",r.style.bottom=tooltipDecorator.offsetY+"px",r.style.width=tooltipDecorator.offsetWidth+"px",t.parentNode.insertBefore(r,t)},mouseleave:function(){r.parentNode.removeChild(r)}};for(o in i)i.hasOwnProperty(o)&&t.addEventListener(o,i[o],!1);return{teardown:function(){for(o in i)i.hasOwnProperty(o)&&t.removeEventListener(o,i[o],!1)}}};tooltipDecorator.className="tooltip",tooltipDecorator.element="div",tooltipDecorator.offsetX=0,tooltipDecorator.offsetY=10,tooltipDecorator.offsetWidth="200",Ractive.decorators.tooltip=tooltipDecorator;var views=void 0,controllers=void 0,utilities=function(){function t(t,e,r){t=t.slice();var i=t.sort(function(t,i){return t[e]<i[e]?-r:r});return i}function e(t){return t.toString().toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"")}function r(t){return"y"===t.toLowerCase()||"true"===t.toLowerCase()||1==t?!0:!1}return{sort:t,isTrue:r,slugify:e}}(),services=function(){function t(t){var e="1kOOvztwbY1RNm545RKG8Ua6bh2GgX-P_wFadPkdH2ig";Tabletop.init({key:e,callback:function(e,r){t(r.sheets("places").elements,r.sheets("indicators").elements,r.sheets("values").elements)},simpleSheet:!1,prettyColumnNames:!1})}function e(t){for(var e={},r=[],i=[],o=[],s=0;s<t.length;s++){var n=t[s].id;e[n]=t[s],utilities.isTrue(t[s].grouping)&&i.push(n),utilities.isTrue(t[s].scoring)&&(r.push(n),utilities.isTrue(t[s]["default"])&&(o.push(n),e[n].visible=!0))}return console.log("processed indicators"),{all:e,scoring:r,grouping:i,visible:o}}function r(t,e,r){var i=t;return i.map(function(t){t.score=0,t.valuesMap={},e.filter(function(e,r){return e.placeid===t.id&&(t.valuesMap[e.indicatorid]=e),!0})}),console.log("processed places",i[145].title),i}function i(t,e){console.log(t,e,"calculate score");var e=e?e:[],r=t;return r.map(function(t){t.places=t.places.map(function(t){var r=!0,i=0,o=t.valuesMap;for(var s in o)r&&e.indexOf(o[s].indicatorid)>-1&&(o[s].normalised?i+=parseInt(o[s].normalised):r=!1);return t.first=!1,t.score=i,t.show=r,t}).filter(function(t){return t.show}),t&&t.places&&t.places[0]&&(t.places[0].first=!0)}),console.log(t[0].places[50],r,"calculate score end"),r}function o(t,e,r,i,o){var s=t,n=i,a={},i=[];if(n){for(var l in s){var c=s[l].valuesMap[n];if(c&&c.normalised){var p=utilities.slugify(c.normalised);p in a||(a[p]={id:p,value:c.normalised,places:[]}),a[p].places.push(s[l])}}var u=o?o.split("|"):Object.keys(a).sort(function(t,e){return e>t});for(var d in u){var f=a[utilities.slugify(u[d])];f.places=utilities.sort(f.places,e,r),i.push(f)}}else i.push({id:"",places:utilities.sort(s,e,r)});return console.log("updated"),i}return{getData:t,prepareIndicators:e,preparePlaces:r,calculateVisibleScores:i,updateGrouping:o}}(),app=function(t){function e(t,e,r){var i=services.prepareIndicators(e),o=services.preparePlaces(t,r,i.visible);n.set("indicators",i),n.get("groups","before"),n.set("groups",services.calculateVisibleScores([{id:"",places:o}],n.get("indicators.visible"))),n.get("groups","after"),n.set("model",o)}function r(){services.getData(e),n.on("sorting.sort",function(t,e){this.set("sorting.column",e),this.set("sorting.direction",-1*this.get("sorting.direction"))}),n.on("filtering.filter.toggle",function(t){n.get("filter.open")?n.set("filter.open",!1):n.set("filter.open",!0)}),n.on("indicator.remove",function(t,e){this.remove("indicators.visible",t.context)}),n.observe("sorting indicators.visible",function(t,e,r){if(t){var i=services.updateGrouping(n.get("model"),n.get("sorting.column"),n.get("sorting.direction"),n.get("sorting.grouping"),n.get("indicators.all."+n.get("sorting.grouping")+".sortorder"));console.log(t,e,r,"oversvable"),n.set("groups",services.calculateVisibleScores(i,this.get("indicators.visible")))}})}var i={loading:[],indicators:[],model:[],groups:[],filter:{open:!1},sorting:{column:"title",direction:1,grouping:""},getIndicator:function(t,e){return this.get("indicators.all")[t][e]},isVisible:function(t){return this.get("indicators.visible").indexOf(t)>-1}},o=Ractive.extend({isolated:!1,template:Templates.filter}),s=Ractive.extend({isolated:!1,template:Templates.group}),n=new Ractive({el:"#app",template:Templates.list,data:i,computed:{},components:{filtering:o,grouping:s}});return{start:r}}(window);